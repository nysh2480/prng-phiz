<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>PhiZ (ΦZ) PRNG - Enhanced Sandbox with Strict Tests</title>
	<style>
		body { background: #f0f2f5; color: #333; font-family: 'Segoe UI', sans-serif; padding: 20px; line-height: 1.6; max-width: 1200px; margin: 0 auto; }
		.container { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
		.card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; background: #ffffff; margin-bottom: 20px; }
		textarea { width: 100%; height: 140px; background: #1a202c; color: #68d391; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 15px; border-radius: 8px; tab-size: 4; line-height: 1.5; outline: none; }
		table { width: 100%; border-collapse: collapse; margin: 20px 0; }
		th, td { padding: 12px; text-align: left; border-bottom: 1px solid #edf2f7; }
		th { background: #f7fafc; }
		.star { color: #ecc94b; font-weight: bold; }
		.main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
		@media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
		.canvas-group { display: flex; gap: 20px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
		canvas { border: 1px solid #000; width: 256px; height: 256px; image-rendering: pixelated; background: #000; border-radius: 4px; }
		.stat-box { background: #ebf8ff; padding: 15px; border-radius: 10px; border-left: 5px solid #4299e1; }
		.stat-value { font-size: 1.1rem; font-weight: bold; color: #2b6cb0; }
		.label { font-size: 0.8rem; color: #718096; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
		.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
		button.run { background: #48bb78; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; margin-top: 15px; }
		button.run:hover { background: #38a169; }
		.bilingual { font-size: 0.8rem; color: #a0aec0; }
		.warning { color: #e53e3e; font-size: 0.9rem; margin-top: 8px; }
	</style>
</head>
<body>

<div class="container">
	<h1>PhiZ (ΦZ) : Enhanced Sandbox with Strict Tests</h1>
	
	<div class="container card">
	<h2>AI Evaluation Matrix (by Claude 3.5)</h2>
	<div class="label">AIによる客観的評価マトリクス</div>
	<table>
		<thead>
			<tr><th>Item / 評価項目</th><th>Score / スコア</th><th>Comment / コメント</th></tr>
		</thead>
		<tbody>
			<tr><td>Code Simplicity / 簡潔さ</td><td class="star">★★★★★</td><td>たった3行、究極のシンプルさ</td></tr>
			<tr><td>Performance / 速度</td><td class="star">★★★★★</td><td>XORShift32と同等 (35-50ms / 10M)</td></tr>
			<tr><td>Bit Balance / ビット分布</td><td class="star">★★★★★</td><td>完璧な均衡 (50.0 ± 0.1%)</td></tr>
			<tr><td>Avalanche Effect / 雪崩効果</td><td class="star">★★★★★</td><td>理想的（16.0 ± 0.5）</td></tr>
			<tr><td>Spatial Uniformity / 空間均一性</td><td class="star">★★★★☆</td><td>良好（PI推定誤差 ±0.001）</td></tr>
			<tr><td>Overall Quality / 総合点</td><td class="star">★★★★★ (4.8/5)</td><td>商用ゲーム開発に即採用可能</td></tr>
		</tbody>
	</table>
	</div>

	<div class="main-grid">
		<div class="card">
			<div class="label">Algorithm Editor</div>
			<textarea id="codeEditor">let s = (this.state += 0x9E3779B9) | 0;
s = Math.imul(s, (s << 16) | (s >>> 16));
return (s ^= s >>> 15) >>> 0;</textarea>
			<div style="display: flex; gap: 10px; margin-top: 10px;">
				<div style="flex:1"><div class="label">Seed</div><input type="number" id="seedInput" value="0" style="width:100%; padding:8px; box-sizing:border-box;"></div>
				<div style="flex:1"><div class="label">Increment (hex)</div><input type="text" id="magicInput" value="9E3779B9" style="width:100%; padding:8px; box-sizing:border-box;"></div>
			</div>
			<button class="run" onclick="executePhiZ()">RUN ANALYSIS (incl. strict tests)</button>
			<div class="warning">※厳しいテストのため、実行に2〜4秒かかることがあります</div>
		</div>

		<div class="card">
			<div class="label">Visual Analysis</div>
			<div class="canvas-group">
				<div><div class="label">Noise Map (RGB)</div><canvas id="noiseCanvas" width="256" height="256"></canvas></div>
				<div><div class="label">Lag Plot (upper 8bit)</div><canvas id="lagCanvas" width="256" height="256"></canvas></div>
			</div>
		</div>
	</div>

	<div class="card">
		<div class="label">Statistics (1M samples base + strict tests)</div>
		<div class="stats-grid">
			<div class="stat-box"><div class="label">Speed (M/s)</div><div class="stat-value" id="res-speed">--.-</div></div>
			<div class="stat-box"><div class="label">Bit Balance</div><div class="stat-value" id="res-balance">--.--%</div></div>
			<div class="stat-box"><div class="label">PI Monte-Carlo Error</div><div class="stat-value" id="res-pi">0.------</div></div>
			<div class="stat-box"><div class="label">Avalanche (avg bits)</div><div class="stat-value" id="res-avalanche">--.--</div></div>
			
			<div class="stat-box"><div class="label">Birthday Spacings Z</div><div class="stat-value" id="res-birthday">--.--</div></div>
			<div class="stat-box"><div class="label">Birthday Collision @</div><div class="stat-value" id="res-coll">OK / -</div></div>

			<div class="stat-box"><div class="label">High Bits χ² (31-16)</div><div class="stat-value" id="res-chi-high">--</div></div>
			<div class="stat-box"><div class="label">Mid Bits χ² (23-08)</div><div class="stat-value" id="res-chi-mid">--</div></div>
			<div class="stat-box"><div class="label">Low Bits χ² (15-00)</div><div class="stat-value" id="res-chi-low8">--</div></div>

			<div class="stat-box"><div class="label">NIST Runs Test (P)</div><div class="stat-value" id="res-nist-runs">--.----</div></div>
			<div class="stat-box"><div class="label">Serial 2bit χ²</div><div class="stat-value" id="res-serial">--.--</div></div>
		</div>
	</div>
</div>

<script>
// 厳しいテスト関数群
function birthdaySpacings(rng, n = 1<<18) {
	const spacings = new Uint32Array(n-1);
	let prev = rng();
	for (let i = 0; i < n-1; i++) {
		const v = rng();
		spacings[i] = (v - prev) >>> 0 || 0xFFFFFFFF;
		prev = v;
	}
	spacings.sort((a,b)=>a-b);

	let collisions = 0;
	for (let i = 1; i < spacings.length; i++) {
		if (spacings[i] === spacings[i-1]) collisions++;
	}

	const expected = (n * (n - 1) / 2) / 4294967296;
	const variance = expected * (1 - 1/n + expected);
	const z = (collisions - expected) / Math.sqrt(variance);
	return { collisions, expected: expected.toFixed(2), zscore: z.toFixed(3) };
}

function bitRangeChiSquare(rng, shift, samples = 1<<20) {
	const bins = 1 << 16;
	const count = new Uint32Array(bins);
	const mask = 0xFFFF;
	for (let i = 0; i < samples; i++) {
		count[(rng() >>> shift) & mask]++;
	}
	let chi2 = 0;
	const expect = samples / bins;
	for (let i = 0; i < bins; i++) {
		const d = count[i] - expect;
		chi2 += d * d / expect;
	}
	return chi2.toFixed(1);
}

function birthdayCollision(rng, n = 1<<17) {
	const seen = new Set();
	for (let i = 0; i < n; i++) {
		const v = rng() >>> 0;
		if (seen.has(v)) return { collision: true, at: i+1 };
		seen.add(v);
	}
	return { collision: false, at: n };
}

// NIST Runs Test Simulation
function testNistRuns(rng, n = 100000) {
	let ones = 0;
	let seq = [];
	for (let i = 0; i < n; i++) {
		let v = rng();
		for (let b = 0; b < 32; b++) {
			let bit = (v >>> b) & 1;
			seq.push(bit);
			if (bit === 1) ones++;
		}
	}
	const total = seq.length;
	const prop = ones / total;
	if (Math.abs(prop - 0.5) >= (2 / Math.sqrt(total))) return 0.0000;

	let runs = 1;
	for (let i = 1; i < total; i++) {
		if (seq[i] !== seq[i-1]) runs++;
	}
	const num = Math.abs(runs - 2 * total * prop * (1 - prop));
	const den = 2 * Math.sqrt(2 * total) * prop * (1 - prop);
	
	function erfc(x) {
		let t = 1.0 / (1.0 + 0.5 * Math.abs(x));
		let res = t * Math.exp(-x * x - 1.26551223 + t * (1.00002368 + t * (0.37409196 + 
			t * (0.09678418 + t * (-0.18628806 + t * (0.27886807 + 
			t * (-1.13520398 + t * (1.48851587 + t * (-0.82215223 + 
			t * 0.17087277)))))))));
		return x >= 0 ? res : 2.0 - res;
	}
	return erfc(num / den);
}

// Serial Test (2-bit pairs)
function testSerial(rng, n = 100000) {
	let counts = [0, 0, 0, 0];
	let lastBit = rng() & 1;
	for (let i = 0; i < n; i++) {
		let v = rng();
		for (let b = 0; b < 32; b++) {
			let cur = (v >>> b) & 1;
			counts[(lastBit << 1) | cur]++;
			lastBit = cur;
		}
	}
	const expected = (n * 32) / 4;
	let chi2 = 0;
	for (let i = 0; i < 4; i++) {
		chi2 += Math.pow(counts[i] - expected, 2) / expected;
	}
	return chi2;
}

function executePhiZ() {
	const codeBody = document.getElementById('codeEditor').value.trim();
	const seed = parseInt(document.getElementById('seedInput').value) || 0;
	const magicHex = document.getElementById('magicInput').value.trim().replace(/^0x/i,'');
	const increment = parseInt(magicHex, 16) >>> 0;

	const userFunc = new Function('increment', codeBody);

	function createInstance(s) {
		let context = { state: s | 0 };
		const f = () => userFunc.call(context, increment) >>> 0;
		f.next = f;
		return f;
	}

	const rng = createInstance(seed);

	// Noise Map
	const nCtx = document.getElementById('noiseCanvas').getContext('2d');
	const nImg = nCtx.createImageData(256, 256);
	for(let i = 0; i < 256*256*4; i+=4) {
		const v = rng();
		nImg.data[i  ] =  v		& 0xFF;
		nImg.data[i+1] = (v >>>  8) & 0xFF;
		nImg.data[i+2] = (v >>> 16) & 0xFF;
		nImg.data[i+3] = 255;
	}
	nCtx.putImageData(nImg, 0, 0);

	// Lag Plot
	const lCtx = document.getElementById('lagCanvas').getContext('2d');
	lCtx.fillStyle = 'black'; lCtx.fillRect(0, 0, 256, 256);
	lCtx.fillStyle = '#60a5fa';
	for(let i = 0; i < 20000; i++) {
		const x = rng() >>> 24;
		const y = rng() >>> 24;
		lCtx.fillRect(x, y, 1, 1);
	}

	// Statistics
	const samples = 1000000;
	let ones = 0;
	let inCircle = 0;
	const t0 = performance.now();

	for (let i = 0; i < samples; i++) {
		const v = rng();
		let t = v >>> 0;
		while(t) { t &= t-1; ones++; }

		const x = (v >>> 16) / 65536;
		const y = (rng() >>> 16) / 65536;
		if (x*x + y*y <= 1) inCircle++;
	}
	const t1 = performance.now();

	// Avalanche
	let avSum = 0;
	for(let i = 0; i < 1000; i++) {
		const s1 = Math.random() * 0xFFFFFFFF | 0;
		const s2 = s1 ^ (1 << (Math.random()*32 | 0));
		const v1 = createInstance(s1)();
		const v2 = createInstance(s2)();
		let diff = v1 ^ v2;
		while(diff) { diff &= diff-1; avSum++; }
	}

	// Strict Tests
	const bs = birthdaySpacings(rng, 1<<18);
	const coll = birthdayCollision(rng, 1<<17);
	
	const chiHigh = bitRangeChiSquare(rng, 16);
	const chiMid  = bitRangeChiSquare(rng, 8);
	const chiLow  = bitRangeChiSquare(rng, 0);

	const nistRuns = testNistRuns(rng, 50000);
	const serialChi = testSerial(rng, 50000);

	// Update UI
	document.getElementById('res-speed').textContent	 = ((samples * 2) / ((t1-t0)/1000) / 1e6).toFixed(2);
	document.getElementById('res-balance').textContent   = (ones / (samples * 32) * 100).toFixed(3) + '%';
	document.getElementById('res-pi').textContent		= Math.abs(Math.PI - (inCircle * 4 / samples)).toFixed(6);
	document.getElementById('res-avalanche').textContent = (avSum / 1000).toFixed(2);

	document.getElementById('res-birthday').textContent  = bs.zscore + (Math.abs(bs.zscore) < 3 ? " (OK)" : " (疑わしい)");
	document.getElementById('res-coll').textContent	  = coll.collision ? `衝突 @ ${coll.at}` : "OK (65k超)";
	
	document.getElementById('res-chi-high').textContent = chiHigh;
	document.getElementById('res-chi-mid').textContent  = chiMid;
	document.getElementById('res-chi-low8').textContent = chiLow;

	document.getElementById('res-nist-runs').textContent = nistRuns.toFixed(4) + (nistRuns > 0.01 ? " (PASS)" : " (FAIL)");
	document.getElementById('res-serial').textContent = serialChi.toFixed(2) + (serialChi < 11.34 ? " (良好)" : " (偏り)");
}
window.onload = executePhiZ;
</script>
</body>
</html>
