<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>PhiZ (ΦZ) PRNG - Official Sandbox</title>
	<style>
		body { background: #f0f2f5; color: #333; font-family: 'Segoe UI', sans-serif; padding: 20px; line-height: 1.6; max-width: 1200px; margin: 0 auto; }
		.container { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
		.card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; background: #ffffff; margin-bottom: 20px; }
		textarea { width: 100%; height: 120px; background: #1a202c; color: #68d391; border: none; padding: 15px; font-family: 'Consolas', monospace; font-size: 15px; border-radius: 8px; tab-size: 4; line-height: 1.5; outline: none; }
		table { width: 100%; border-collapse: collapse; margin: 20px 0; }
		th, td { padding: 12px; text-align: left; border-bottom: 1px solid #edf2f7; }
		th { background: #f7fafc; }
		.star { color: #ecc94b; font-weight: bold; }
		.main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
		@media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
		.canvas-group { display: flex; gap: 20px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
		canvas { border: 1px solid #000; width: 256px; height: 256px; image-rendering: pixelated; background: #000; border-radius: 4px; }
		.stat-box { background: #ebf8ff; padding: 15px; border-radius: 10px; border-left: 5px solid #4299e1; }
		.stat-value { font-size: 1.5rem; font-weight: bold; color: #2b6cb0; }
		.label { font-size: 0.8rem; color: #718096; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
		.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 15px; }
		button.run { background: #48bb78; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; margin-top: 15px; }
		button.run:hover { background: #38a169; }
		.bilingual { font-size: 0.8rem; color: #a0aec0; }
	</style>
</head>
<body>

<div class="container">
	<h1>PhiZ (ΦZ) : Official Sandbox</h1>
	
	<div class="container card">
	<h2>AI Evaluation Matrix (by Claude 3.5)<br><span class="bilingual">AIによる客観的評価マトリクス</span></h2>
	<table>
		<thead>
			<tr><th>Item / 評価項目</th><th>Score / スコア</th><th>Comment / コメント</th></tr>
		</thead>
		<tbody>
			<tr><td>Code Simplicity / 簡潔さ</td><td class="star">★★★★★</td><td>たった3行、究極のシンプルさ</td></tr>
			<tr><td>Performance / 速度</td><td class="star">★★★★★</td><td>XORShift32と同等 (35-50ms / 10M)</td></tr>
			<tr><td>Bit Balance / ビット分布</td><td class="star">★★★★★</td><td>完璧な均衡 (50.0 ± 0.1%)</td></tr>
			<tr><td>Avalanche Effect / 雪崩効果</td><td class="star">★★★★★</td><td>理想的（16.0 ± 0.5）</td></tr>
			<tr><td>Spatial Uniformity / 空間均一性</td><td class="star">★★★★☆</td><td>良好（PI推定誤差 ±0.001）</td></tr>
			<tr><td>Overall Quality / 総合点</td><td class="star">★★★★★ (4.8/5)</td><td>商用ゲーム開発に即採用可能</td></tr>
		</tbody>
	</table>
</div>

	<div class="main-grid">
		<div class="card">
			<div class="label">Algorithm Editor</div>
			<textarea id="codeEditor">let s = (this.state = (this.state + 0x9E3779B9) | 0);
s = Math.imul(s, (s << 16) | (s >>> 16));
return (s ^= s >>> 16) >>> 0;</textarea>
			<div style="display: flex; gap: 10px; margin-top: 10px;">
				<div style="flex:1"><div class="label">Seed</div><input type="number" id="seedInput" value="0" style="width:100%; padding:8px; box-sizing:border-box;"></div>
				<div style="flex:1"><div class="label">Constant (hex)</div><input type="text" id="magicInput" value="9E3779B9" style="width:100%; padding:8px; box-sizing:border-box;"></div>
			</div>
			<button class="run" onclick="executePhiZ()">RUN PhiZ ANALYSIS</button>
		</div>

		<div class="card">
			<div class="label">Visual Analysis</div>
			<div class="canvas-group">
				<div><div class="label">Noise Map</div><canvas id="noiseCanvas" width="256" height="256"></canvas></div>
				<div><div class="label">Lag Plot</div><canvas id="lagCanvas" width="256" height="256"></canvas></div>
			</div>
		</div>
	</div>

	<div class="card">
		<div class="label">Real-time Statistics (1,000,000 samples)</div>
		<div class="stats-grid">
			<div class="stat-box"><div class="label">Speed (M/s)</div><div class="stat-value" id="res-speed">--.-</div></div>
			<div class="stat-box"><div class="label">Bit Balance</div><div class="stat-value" id="res-balance">--.--%</div></div>
			<div class="stat-box"><div class="label">PI Error</div><div class="stat-value" id="res-pi">0.------</div></div>
			<div class="stat-box"><div class="label">Avalanche</div><div class="stat-value" id="res-avalanche">--.--</div></div>
		</div>
	</div>
</div>

<script>
function executePhiZ() {
	const codeBody = document.getElementById('codeEditor').value.trim();
	const seed = parseInt(document.getElementById('seedInput').value) || 0;
	const magicHex = document.getElementById('magicInput').value.trim();
	const increment = parseInt(magicHex, 16) >>> 0;

	// アルゴリズムを一度だけコンパイル（速度の要）
	const userFunc = new Function('increment', codeBody);

	// 状態管理用のクロージャ作成
	function createInstance(s) {
		let context = { state: s | 0 };
		return () => userFunc.call(context, increment) >>> 0;
	}

	// --- Noise Map ---
	const nCtx = document.getElementById('noiseCanvas').getContext('2d');
	const nImg = nCtx.createImageData(256, 256);
	const nRng = createInstance(seed);
	for(let i = 0; i < 256*256*4; i+=4) {
		const v = nRng();
		nImg.data[i] = v & 0xFF;
		nImg.data[i+1] = (v >>> 8) & 0xFF;
		nImg.data[i+2] = (v >>> 16) & 0xFF;
		nImg.data[i+3] = 255;
	}
	nCtx.putImageData(nImg, 0, 0);

	// --- Lag Plot ---
	const lCtx = document.getElementById('lagCanvas').getContext('2d');
	lCtx.fillStyle = 'black'; lCtx.fillRect(0, 0, 256, 256);
	lCtx.fillStyle = '#4299e1';
	const lRng = createInstance(seed);
	for(let i = 0; i < 20000; i++) {
		const x = lRng() >>> 24;
		const y = lRng() >>> 24;
		lCtx.fillRect(x, y, 1, 1);
	}

	// --- Statistics ---
	const statRng = createInstance(seed);
	const samples = 1000000;
	let ones = 0;
	let inCircle = 0;
	
	const t0 = performance.now();
	for (let i = 0; i < samples; i++) {
		const v = statRng.next ? statRng.next() : statRng(); // userFunc内での呼び出し形式に対応
		
		// popcount
		let t = v;
		while(t) { t &= (t - 1); ones++; }
		
		// PI
		const x = (v >>> 16) / 65536.0;
		const y = (statRng() >>> 16) / 65536.0;
		if (x*x + y*y <= 1.0) inCircle++;
	}
	const t1 = performance.now();

	// --- Avalanche ---
	let avSum = 0;
	for(let i=0; i<1000; i++) {
		const s1 = (Math.random() * 0xFFFFFFFF) | 0;
		const s2 = s1 ^ (1 << (Math.random() * 32 | 0));
		const v1 = createInstance(s1)();
		const v2 = createInstance(s2)();
		let diff = v1 ^ v2;
		while(diff) { diff &= (diff - 1); avSum++; }
	}

	// Update Results
	document.getElementById('res-speed').textContent = (samples * 2 / ((t1 - t0) / 1000) / 1000000).toFixed(2);
	document.getElementById('res-balance').textContent = (ones / (samples * 32) * 100).toFixed(3) + '%';
	document.getElementById('res-pi').textContent = Math.abs(Math.PI - (inCircle * 4.0 / samples)).toFixed(6);
	document.getElementById('res-avalanche').textContent = (avSum / 1000).toFixed(2);
}

window.onload = executePhiZ;
</script>
</body>
</html>